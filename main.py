query_template = """
-- INSERT INTO `prd-data-ap.prd_astrapay_staging.aopSFTP`
-- (
--     Approval_Code,
--     Card_Number,
--     Card_type,
--     Debit_Credit_Indicator,
--     gross_amount,
--     merchant_group_id,
--     mdr,
--     mid,
--     edc_no,
--     merchant_name,
--     net_amount,
--     original_amount,
--     payment_date,
--     process_date,
--     Rec_Source,
--     Redeem_Amount,
--     Reward_Amount,
--     Charges_Amount,
--     payment_status,
--     Report_Date,
--     Settle_Date,
--     settle_time,
--     TID,
--     transaction_date,
--     transaction_time,
--     seq_no,
--     trace_no,
--     trans_code,
--     bank_account
-- )
    
  with additional_transaction AS (
  select
  -- tm.transaction_number as approval_code,
  CASE WHEN LENGTH(b.bill_number) > 6 THEN SUBSTR(b.bill_number, LENGTH(b.bill_number) - 5, 6)ELSE b.bill_number END as
    Approval_Code,
    0 AS Card_Number, 0 AS Card_type, 0 AS Debit_Credit_Indicator, cast(tm.total_price as string) as gross_amount,be_ancestor.description merchant_group_id, mq.mdr as mdr, mq.mid as mid, 0 AS edc_no, mq.merchant_short_name as merchant_name, CASE
    WHEN cast( right(CAST(tm.total_price - tm.included_service_charge as String),1)as numeric) > 5 THEN cast(CEIL(tm.total_price - tm.included_service_charge) as String)
  ELSE cast(FLOOR(tm.total_price - tm.included_service_charge) as String) END as net_amount,
      0 AS original_amount,cast(tm.transaction_at as string format 'yyyymmdd') payment_date,
      {settle_date} as process_date,
      -- FORMAT_DATE('%Y%m%d', CURRENT_DATE()) AS process_date,
      'TC' AS Rec_Source, 0 AS Redeem_Amount, 0 AS Reward_Amount,
      CASE WHEN cast( right(CAST(tm.included_service_charge as String),1) as numeric) > 5
    THEN cast(CEIL(tm.included_service_charge) as String) ELSE cast(FLOOR(tm.included_service_charge) as String) END as Charges_Amount,
      'PAID' AS payment_status,cast(tm.transaction_at as string format 'yyyymmdd') as Report_Date,
      {settle_date} as Settle_Date,
        -- FORMAT_DATE('%Y%m%d', CURRENT_DATE()) as Settle_Date,
      cast(tm.transaction_at as string format 'hhmiss') as settle_time,  
      t.terminal_code as TID, cast(tm.transaction_at as string format 'yyyymmdd') as transaction_date,
      cast(tm.transaction_at as string format 'hhmiss') as transaction_time,0 AS seq_no,0 AS trace_no,
        coalesce(tm.issuer_nns,'93600822') as trans_code,'0653045546' AS bank_account FROM prd-business-ap.qris_merchant.transaction_merchant  tm join prd-business-ap.qris_merchant.merchant_qr mq on tm.merchant_qr_id
      = mq.id
  JOIN prd-core-ap.user.business_entity_group beg ON mq.user_id = beg.descendant JOIN prd-core-ap.user.business_entity be_ancestor ON beg.ancestor = be_ancestor.id
  JOIN prd-core-ap.user.business_entity be_descendant ON beg.descendant = be_descendant.id
  left join prd-business-ap.qris_merchant.terminal t ON tm.terminal_id = t.id
  left join prd-business-ap.qris.transaction trx on tm.transaction_id_reference = trx.id
  left join prd-business-ap.qris.bill  b on trx.id = b.transaction_id and t.id = b.terminal_id
    WHERE tm.transaction_number in ({on_us_code}) and be_ancestor.description = 'AOP HO'),
 
  additional_transaction2 AS (
  select
  -- tm.reconcile_code,
  CASE WHEN LENGTH(b.bill_number) > 6 THEN SUBSTR(b.bill_number, LENGTH(b.bill_number) - 5, 6)ELSE b.bill_number END as Approval_Code,
  0 AS Card_Number, 0 AS Card_type, 0 AS Debit_Credit_Indicator, cast(tm.total_price as string) as gross_amount ,be_ancestor.description merchant_group_id, mq.mdr as mdr, mq.mid as mid, 0 AS edc_no, mq.merchant_short_name as merchant_name, CASE
    WHEN cast( right(CAST(tm.total_price - tm.included_service_charge as String),1)as numeric) > 5 THEN cast(CEIL(tm.total_price - tm.included_service_charge) as String)
    ELSE cast(FLOOR(tm.total_price - tm.included_service_charge) as String) END as net_amount,
      0 AS original_amount,cast(tm.transaction_at as string format 'yyyymmdd') payment_date,
      -- FORMAT_DATE('%Y%m%d', CURRENT_DATE()) AS process_date,
      {settle_date} as process_date,
      'TC' AS Rec_Source, 0 AS Redeem_Amount, 0 AS Reward_Amount,
      CASE WHEN cast( right(CAST(tm.included_service_charge as String),1) as numeric) > 5
    THEN cast(CEIL(tm.included_service_charge) as String) ELSE cast(FLOOR(tm.included_service_charge) as String) END as Charges_Amount,
      'PAID' AS payment_status,cast(tm.transaction_at as string format 'yyyymmdd') as Report_Date,
    -- FORMAT_DATE('%Y%m%d', CURRENT_DATE()) as Settle_Date,
      {settle_date} as Settle_Date,
      cast(tm.transaction_at as string format 'hhmiss') as settle_time,  
      t.terminal_code as TID, cast(tm.transaction_at as string format 'yyyymmdd') as transaction_date,
      cast(tm.transaction_at as string format 'hhmiss') as transaction_time,0 AS seq_no,0 AS trace_no,
        coalesce(tm.issuer_nns,'93600822') as trans_code,'0653045546' AS bank_account
      FROM prd-business-ap.qris_merchant.transaction_merchant  tm join prd-business-ap.qris_merchant.merchant_qr mq on tm.merchant_qr_id = mq.id
  JOIN prd-core-ap.user.business_entity_group beg ON mq.user_id = beg.descendant JOIN prd-core-ap.user.business_entity be_ancestor ON beg.ancestor = be_ancestor.id
  JOIN prd-core-ap.user.business_entity be_descendant ON beg.descendant = be_descendant.id
  left join prd-business-ap.qris_merchant.terminal t ON tm.terminal_id = t.id
  left join prd-business-ap.qris.transaction trx on tm.transaction_id_reference = trx.id
  left join prd-business-ap.qris.bill  b on trx.id = b.transaction_id and t.id = b.terminal_id
    WHERE
  tm.reconcile_code in ({off_us_code})
  AND tm.status = 'SUCCESS'
      AND beg.ancestor = 10004823
      AND depth != 0
      AND mq.merchant_name != 'AstraOtoshop'
  and be_ancestor.description = 'AOP HO'
  and extract (year from tm.transaction_at) = extract(year from current_date())
  -- INI NAMBAHIN KETIKA BULANNYA ADA YANG BEDA / DATANYA ADA YANG TIDAK SAMA
  -- and extract (month from tm.transaction_at) = extract(month from current_date())
  )
 
  -- result as (
    select * from additional_transaction
    union all
    select * from additional_transaction2
  -- )
 
--   SELECT
--   SUM(CAST(result.net_amount AS FLOAT64)) AS total_net_amount,
--   SUM(CAST(result.gross_amount AS FLOAT64)) AS total_gross_amount
-- FROM result
 """

settle_date = '20251105'

on_us_code = """
INV/QRM/3H12R4/251104/2VFI8AWG
INV/QRM/3H12VD/251104/3QU68XYQ
"""""

off_us_code = """
511447282754
926294169542
926309740106
012755367243
926318393283
511444760786
012755541135
511444776327
511444780094
511444781947
511444786372
511444789781
511447676367
511444797267
926335878012
511444812937
511444811997
926338143518
511444826077
511444841127
511444844522
511444847848
511444846272
511444847634
926346331702
511447739257
012755949177
000000017739
926349215935
000371703576
511444862889
511447749651
511447753662
251104045068
511447762333
511444882511
511444885129
511447768965
511447773454
511444890064
511447787625
511447789921
511440002658
511447794368
511447799214
511447798836
012756184820
511440020850
511447817333
511447819781
926369257974
793104838305
926371155072
926372796296
511447837962
511440056871
511447842830
926375986604
511440061112
511447847579
012756396176
012756434566
511440072202
012756450461
511440084746
926382653000
511447874028
511440096675
511447882434
926385535056
926389031323
926392516844
926392951139
511440144393
926396893939
511440148733
926396955528
012756743969
511447937472
926398525285
511447940531
511440158977
517643168652
511440171060
926404592687
251104069037
511440177344
511041111298
005901111356
511447969022
110476691245
511447972485
704473764234
012756895026
511447988872
511447990163
511447996371
511447996086
926414191453
041113173318
511448003806
511448016428
041113173590
926420517191
511448026669
926422529659
511448037269
511448041783
926424325834
511448060219
926430492410
926432540329
511448078488
926433811489
511448083406
511448085298
511440297176
012757292472
511440311942
511448098660
511440312307
511448107135
926440486259
511440350067
511448135390
511448144381
511440367786
041113176448
511448160527
926448615571
511448159036
511448164685
511440398891
926453354420
511448191929
511448191103
926455470274
926456097624
926456952043
511440466332
926465944317
511440485033
926468797094
511448266425
511440494982
926470670582
511448284632
926472661923
511448286374
511440513550
251104259797
926476768073
511448314376
511440547781
012758070675
511448337149
511448337206
511448344288
511440568420
511448347438
926486491905
511440580147
511448363471
511440582077
192485098596
511440588485
926493631357
511440611120
511440617210
511440624462
511440631278
926503728122
926503727668
511448433096
511448435542
511440668348
511440673765
511440674626
511440679583
926511546184
511440689711
511440689778
511440697867
511448481770
511440707523
511448490130
798078273315
511448516512
511440748587
511440755808
926529066789
511440761619
511440764467
926530746909
041522089613
511448553654
511440773790
511440779331
926534516631
511440787122
926535918530
511440790866
926537006152
511440795724
288908264334
926540207688
511448589526
041540368025
511440815901
012759046540
926546041278
511440839017
926548069980
511440845225
926549600605
511448637802
511440873172
511440878258
926555976241
511448658292
511041614567
926557325407
511440886294
926558398388
926559199522
511448679748
000018610296
511448682497
511448683133
926562813731
511440913929
511440928468
511448706122
926566487287
511440939725
511440944230
511440951858
511440953664
251104134036
926572349270
511448739854
511448741136
926575023937
511448754991
511440977112
511448755830
511440979243
926579809882
511440998974
511441001290
511441003978
926582035366
511448790515
511441012478
926583729137
511448802781
926586026293
926586296022
926590289326
926590751120
511448832356
511441061307
511448849733
511448852437
926596813449
926598057828
926599769724
511448877393
511441111575
926603402890
926603740493
926605449259
511448902925
511448904875
368007567824
511441137287
926608419533
511448919145
511448919874
926609226686
926610588622
511448928965
012760113716
511441161252
511441164871
511448956242
012760180686
926616739804
511448973836
041822401205
926622552225
511441257188
041113192039
511441273181
511449048677
511449056875
012760502381
511441308081
926644904272
511449109882
012760663367
012760689576
511449154662
926656899264
511449180235
511449204171
511449205886
926669683347
511441529389
000424352165
511441557401
511449332865
511441575224
511449386698
926699764793
511441646627
926710532069
926713639558
511441842594
511449615261
000217599617
000217694622
1ike19d74305
000219536212
000219779647
000219801444
926319335200
000219956277
296803fb0535
1iki79z06759
000000CT6W0K
000220155911
000220188380
000220209691
017118815564
000220237612
000220238496
1ikio9x24695
1ikip9c99883
292803ec4617
000220387424
000220390029
000220413206
000000CT7925
041125498701
000220437538
000220440198
000220481794
000220502731
000220507563
000220531613
294b03ef7777
000220537534
000220538822
000220564366
000220574076
1ikjk9m79318
29c4040c8508
000220584930
291a03eb3081
1ikjq9k71607
000220652142
000220654070
000220661315
000220671706
000220675741
940837785515
1ikjv9235510
000220711249
000220718342
000220729792
ESB416404602
000220734672
000220761642
000220808496
000220828103
000220831757
000220837443
296f03f74447
298703f71653
000220872769
000220883270
000220902882
000220940671
000220949961
311388633950
000220965463
000220968806
000220973093
000000CT8Z19
000000CT8RMQ
000221005036
000221018847
1ikkn9h97195
000221047156
000221054619
000221060745
000221066857
000221079449
000221104020
295b03f24819
000221124542
242993373069
804864928151
000221134577
295603f08778
000221149891
000221150405
29b704032812
000221156717
000221181331
000221180416
1ikl09m90810
000221203882
000221212108
000221217118
28bc03df6126
000221239924
000221241391
000221247273
28e103ec7267
000221250292
000221292685
000221300008
1ikl99i96163
000221310174
000221321566
1iklaa502352
28df03e91241
000221370763
1iklf9p44538
292d03f16076
AX4U1MDSQXU8
000221390148
AX4U1MDSQY80
000221397141
016904126988
000221412971
000221417104
041125504043
000221423284
000221440389
524435671957
000221452537
000221459124
000221462136
000221504166
000000CTBC79
926384246861
1iklta029508
000221570027
000221570901
926385048357
000221608638
000221611260
000221619637
000221623209
000221626478
293403f79608
000221650386
000221675551
000221679948
000221686931
1ikm4a803042
000221713550
000221717630
AX4UEDRXTM17
000221722156
000221728777
000221754528
000221774769
000221781658
000221787664
000221796056
296f03ff9986
298404092363
000221849517
28f103ee4689
AX4UEDRXTQGS
1ikmhaa03191
000221875657
293f03f86367
000221908256
000000CTCXC5
MTP052384656
000221949206
aacb6e0974e3
000221954716
000221959895
000221965418
000221987847
28d203e98437
000222001748
000221999899
000222029949
000222034099
000222054947
000222061145
000222079197
000222083625
000222084928
000222093291
000222101026
JQI432116248
357baf9fe3e2
159194743951
000222166175
000222182092
290f03ed1064
000222208821
000222241182
000222248659
000222268481
000222277336
000222295807
000222302792
000222309249
295503fc2782
000222363271
000222391228
000222404165
000222434566
000222451563
000222511314
000222584324
000222584382
000222610614
000222618123
28fa03e61726
000222628293
798625970122
000222663146
000222680565
000222691159
000222690892
000222698285
000222754813
000222771548
292703f01138
000222773855
291203f44132
000222801454
041125511531
1iko99245836
211334425224
000222885433
000222905931
000222929604
298c040c4473
000222991012
1ikoh9u72389
292903ed4625
DTKAB4004875
000223121736
000223125743
000223133194
767475086450
ESB709600386
000223145231
000223155683
000223160149
593980434248
000223191897
AX4UEDRXUV9M
000223235558
000223255109
000223274693
000223370272
1ikoz9u77786
000223381457
1ikp09z71428
000223448991
000223494607
000223506087
000223506496
000223541613
000223558213
000223560014
000223577020
000223589913
1ikpaa541053
000000CTH3HH
667134258214
000223682991
000223704816
099740059629
000223740085
000223741570
1ikpiaa31631
000223763585
000223769962
000223772942
000223782546
000223794380
000223795841
000223814592
000223909139
000223946525
000223954809
000223963631
000224009246
000224034931
000224042975
000224043488
000224059125
000224070249
000224159278
ESB779600457
000224217345
130940321760
294a03f62330
000224240844
1ikqaaa38973
000224244695
960565378213
291403f43913
000224328163
290c03e94135
418cd306db7b
1ikqk9y84857
28ca03df5607
000224436393
000224441081
000000CTHRT1
000224471003
000224504419
297603f87463
AX4U1MDSTNN5
000224556408
291903f06199
000224637824
000224681069
295c03ff9234
293503ea8388
AX4UEDRXW5XQ
000224708661
000224741127
090278624733
000224763705
295803f93700
000224783484
000224785595
000224806208
000224811179
017093651970
000224829986
000224833858
000224837794
000224856950
000224857581
000224863762
000224880339
1ikrgaa48902
000224884462
000224883979
000224896028
000224899512
eCsHWGKUINNh
000224936499
000224945351
000225007992
000225013436
000225023914
000225079438
1ikrua566245
000225108941
140917335589
000225121778
000225159090
000225159580
000225161622
000225177764
000000CTM0D1
000225248432
000225262424
AX4UEDRXWNJF
000225276801
000225288398
291103ee0983
000225322043
1iksaam17792
000225325247
290d03f05730
000000CTKYQD
000225371855
000000CTMYN1
000225408446
000225407651
000225413265
000225420687
28e703e30132
000225443553
1iksjao11102
017006076566
000225513598
1iksoae43622
000225522958
000225533978
000225535617
1iksp9258122
016914678463
000225590004
000225594246
690936697579
000225604578
889541995789
000225648394
000225663667
000225672814
000225683181
000225684342
1ikt1a760354
000225729942
000225734007
000000CTN9DX
000000CTN3JQ
000225760241
29a404076282
291603ed7730
000225785530
000225787173
000225794464
000225809458
000225814576
433537059880
000225822632
000225831052
000225844419
000225883820
000225898247
000225913591
000225932222
000225956233
000225972288
000225972299
000225987257
290603ee7865
000226052440
000226054035
000226182158
000226190101
000226202802
000226210032
1iku1aq10961
000226274852
296503f70238
28fe03ed7049
000226355386
28ea03e12218
000226397419
000226404308
BWS004080488
000226433720
000226482940
000226494086
000226535068
000226553197
000226579611
ESB710006991
28df03e54759
000226632823
000226644001
AX4UR5654GEQ
000226681537
320415545335
000226684201
041125532226
294c03f19611
000226733056
000226773215
95ff387f60ec
000226795452
000226818214
000226822800
000226823476
1ikv4a988590
28fe03ec0942
000226828975
000226867488
000226888960
000226899316
080899544012
926555014913
000226946333
707634724499
000227003883
000227007316
299a04034786
1ikvgaf62892
AX4UEDRXY6CV
000227033847
000227050423
1ikvkaj59381
000227100052
1ikvlah66848
000227157121
000227161912
000227179243
1ikvqax00490
000227245103
000227261240
290803f01972
ESB274005724
000227306543
000227312789
000227334977
000227340111
000227354857
000000CTRR10
000227420505
000227435753
000227467946
000227486209
000227503487
1ikwbah74077
295a03f33161
28fb03e87923
000227585227
000227618213
000227637619
000227641976
000227659000
000227671634
000227724578
1ikwoak82090
000015746255
1ikwpae78585
0d421a7c8d42
291403ee5488
000227815108
394671869707
000000CTJCXX
000227896275
959965872464
000227900690
AX4UR5655HHY
000227968663
000227993713
292e03ea9174
000228014238
000228021097
084300104901
000228071900
000228081592
000228085018
000228098144
000193891806
000228152947
000228176194
000228209008
000228213511
000228252107
1ikxiaj78820
000228259110
000228286097
000228305849
000228315724
000228343332
000228343389
000228429565
000228461437
000228508139
000228515816
291103e75342
JQI432693063
000228725264
000228726717
000228745728
29bd04089212
1ikycb306343
000228812644
000228821999
290d03eb0848
000228845951
251104133615
000228905287
000228915943
29a203ff0896
000228953899
926614530736
251104004243
000229073515
000229170658
000229277534
182706197961
1ikz4b612758
000229314281
000229411024
000229431022
000229435825
000229475371
JQI432752005
000229524085
000229576312
000229586968
000229594209
000229596424
000229621136
000229686256
000229738615
000229742365
28f203f01396
28eb03e82335
000229964585
000230080993
1il05au70007
000230144054
000230153318
290b03ee3576
000230211810
000230434653
000230439717
000000CV5M3Z
000230629194
000230706994
000230759000
000230801585
331415638631
000230952223
000231159491
000231324309
000231371412
000231514357
000000CV7KLP
000231665111
000231757463
002530891066
298103fc7989
000231963194
000231988112
000232087679
000232106204
000232108237
000232327484
000232488722
000232541992
876434643203
000232747238
000232754015
29b403ff6360
000233197387
1il65bg91361
000233586980
000233873460
"""


def format_query(query_template, settle_date, on_us_code, off_us_code):
    # Format on_us_code: split by lines, strip whitespace, and wrap each in quotes
    on_us_formatted = "', '".join([code.strip() for code in on_us_code.strip().split('\n') if code.strip()])
    on_us_formatted = f"'{on_us_formatted}'"

    # Format off_us_code: split by lines, strip whitespace, and wrap each in quotes
    off_us_formatted = "', '".join([code.strip() for code in off_us_code.strip().split('\n') if code.strip()])
    off_us_formatted = f"'{off_us_formatted}'"

    # Replace placeholders in query template
    formatted_query = query_template.format(
        settle_date=f"'{settle_date}'",
        on_us_code=on_us_formatted,
        off_us_code=off_us_formatted
    )

    return formatted_query


# Usage
formatted_query = format_query(query_template, settle_date, on_us_code, off_us_code)
print(formatted_query)
